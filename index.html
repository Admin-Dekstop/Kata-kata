aftarSiswa() {
            const container = document.getElementById('daftarSiswa');
            container.innerHTML = '';
            if (state.siswa.length === 0) {
                container.innerHTML = '<p class="text-gray-500 col-span-full text-center">Belum ada data siswa. Silakan tambahkan di atas.</p>';
                return;
            }
            state.siswa.forEach(siswa => {
                const card = document.createElement('div');
                card.className = 'card p-4 flex justify-between items-center border';
                card.innerHTML = `
                    <div>
                        <p class="font-bold text-gray-800">${siswa.nama}</p>
                        <p class="text-sm text-gray-500">${siswa.kelas}</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="showQR('${siswa.id}')" class="text-indigo-600 hover:text-indigo-800" title="Tampilkan QR Code">
                            <i class="fas fa-qrcode fa-lg"></i>
                        </button>
                        <button onclick="hapusSiswa('${siswa.id}')" class="text-red-500 hover:text-red-700" title="Hapus Siswa">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                `;
                container.appendChild(card);
            });
        }
        
        function hapusSiswa(id) {
            if (confirm('Apakah Anda yakin ingin menghapus siswa ini?')) {
                state.siswa = state.siswa.filter(s => s.id !== id);
                renderDaftarSiswa();
                saveToLocalStorage();
            }
        }

        function renderRiwayatAbsensi() {
            const tbody = document.getElementById('riwayatAbsensi');
            tbody.innerHTML = '';
            const today = new Date().toLocaleDateString('id-ID');
            
            const absensiHariIni = state.absensi.filter(absen => {
                const absenDate = new Date(absen.waktu).toLocaleDateString('id-ID');
                return absenDate === today;
            });

            if (absensiHariIni.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center p-4 text-gray-500">Belum ada absensi hari ini.</td></tr>';
                return;
            }

            // Urutkan dari yang terbaru
            absensiHariIni.sort((a, b) => new Date(b.waktu) - new Date(a.waktu));

            absensiHariIni.forEach(absen => {
                const siswa = state.siswa.find(s => s.id === absen.idSiswa);
                if (siswa) {
                    const row = document.createElement('tr');
                    row.className = 'border-b hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="p-3">${siswa.nama}</td>
                        <td class="p-3">${siswa.kelas}</td>
                        <td class="p-3 text-sm text-gray-600">${new Date(absen.waktu).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })}</td>
                    `;
                    tbody.appendChild(row);
                }
            });
        }

        // --- FUNGSI QR CODE & MODAL ---

        function showQR(id) {
            const siswa = state.siswa.find(s => s.id === id);
            if (siswa) {
                const modal = document.getElementById('qr-modal');
                document.getElementById('modal-nama').textContent = siswa.nama;
                document.getElementById('modal-kelas').textContent = siswa.kelas;
                
                const dataToEncode = JSON.stringify({ id: siswa.id, nama: siswa.nama, kelas: siswa.kelas });

                new QRious({
                    element: document.getElementById('qr-canvas'),
                    value: dataToEncode,
                    size: 200,
                    padding: 15,
                    foreground: '#1f2937',
                });

                modal.classList.remove('hidden');
            }
        }
        
        function printQR() {
            const canvas = document.getElementById('qr-canvas');
            const nama = document.getElementById('modal-nama').textContent;
            const kelas = document.getElementById('modal-kelas').textContent;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write('<html><head><title>Cetak QR Code</title>');
            printWindow.document.write('<style>body { font-family: sans-serif; text-align: center; padding-top: 50px; } h2, p { margin: 5px 0; }</style>');
            printWindow.document.write('</head><body>');
            printWindow.document.write(`<h2>${nama}</h2><p>${kelas}</p>`);
            printWindow.document.write('<img src="' + canvas.toDataURL() + '" />');
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.print();
        }

        function closeModal() {
            document.getElementById('qr-modal').classList.add('hidden');
        }

        // --- FUNGSI SISWA (SCANNER) ---

        function startScan() {
            const video = document.getElementById('scanner-video');
            const feedback = document.getElementById('scan-feedback');
            const konfirmasiDiv = document.getElementById('konfirmasi-absen');
            
            konfirmasiDiv.classList.add('hidden');
            feedback.textContent = 'Arahkan kamera ke QR Code Anda.';
            feedback.className = 'text-gray-500 min-h-[24px]';

            navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
                .then(function(stream) {
                    video.srcObject = stream;
                    video.setAttribute("playsinline", true); // required to tell iOS safari we don't want fullscreen
                    video.play();
                    state.scanner = requestAnimationFrame(tick);
                })
                .catch(function(err) {
                    console.error("Error starting camera:", err);
                    feedback.textContent = 'Gagal mengakses kamera.';
                    feedback.className = 'text-red-500 min-h-[24px]';
                });
        }

        function stopScan() {
            if (state.scanner) {
                cancelAnimationFrame(state.scanner);
                state.scanner = null;
            }
            const video = document.getElementById('scanner-video');
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }
        }

        function tick() {
            const video = document.getElementById('scanner-video');
            const feedback = document.getElementById('scan-feedback');
            
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                const canvasElement = document.createElement('canvas');
                const canvas = canvasElement.getContext('2d');
                canvasElement.height = video.videoHeight;
                canvasElement.width = video.videoWidth;
                canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
                const imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "dontInvert",
                });

                if (code) {
                    handleQRData(code.data);
                    return; // Stop scanning once a code is found
                }
            }
            state.scanner = requestAnimationFrame(tick);
        }

        function handleQRData(data) {
            stopScan();
            const feedback = document.getElementById('scan-feedback');
            try {
                const parsedData = JSON.parse(data);
                const siswa = state.siswa.find(s => s.id === parsedData.id);

                if (siswa && siswa.nama === parsedData.nama) {
                    // Cek apakah sudah absen hari ini
                    const today = new Date().toLocaleDateString('id-ID');
                    const sudahAbsen = state.absensi.some(absen => 
                        absen.idSiswa === siswa.id && 
                        new Date(absen.waktu).toLocaleDateString('id-ID') === today
                    );

                    if (sudahAbsen) {
                        feedback.textContent = `Halo ${siswa.nama}, Anda sudah absen hari ini.`;
                        feedback.className = 'text-green-600 font-bold min-h-[24px]';
                        setTimeout(() => showPage('main-page'), 3000);
                    } else {
                        feedback.textContent = 'QR Code terdeteksi!';
                        feedback.className = 'text-green-600 font-bold min-h-[24px]';
                        
                        document.getElementById('nama-konfirmasi').textContent = siswa.nama;
                        document.getElementById('kelas-konfirmasi').textContent = siswa.kelas;
                        document.getElementById('id-konfirmasi').value = siswa.id;
                        document.getElementById('konfirmasi-absen').classList.remove('hidden');
                    }
                } else {
                    throw new Error("QR Code tidak valid atau tidak cocok.");
                }
            } catch (e) {
                console.error("Error parsing QR data:", e);
                feedback.textContent = 'QR Code tidak valid. Coba lagi.';
                feedback.className = 'text-red-500 font-bold min-h-[24px]';
                // Restart scan after a delay
                setTimeout(startScan, 2000);
            }
        }

        function submitAbsen() {
            const idSiswa = document.getElementById('id-konfirmasi').value;
            const absenBaru = {
                idSiswa: idSiswa,
                waktu: new Date().toISOString(),
            };
            state.absensi.push(absenBaru);
            saveToLocalStorage();
            
            alert('Absensi berhasil dicatat!');
            showPage('main-page');
        }

        // --- FUNGSI LOCAL STORAGE ---
        function saveToLocalStorage() {
            localStorage.setItem('absensiDataSiswa', JSON.stringify(state.siswa));
            localStorage.setItem('absensiDataAbsen', JSON.stringify(state.absensi));
        }

        function loadFromLocalStorage() {
            const dataSiswa = localStorage.getItem('absensiDataSiswa');
            const dataAbsen = localStorage.getItem('absensiDataAbsen');
            if (dataSiswa) {
                state.siswa = JSON.parse(dataSiswa);
            }
            if (dataAbsen) {
                state.absensi = JSON.parse(dataAbsen);
            }
        }

        // Inisialisasi aplikasi
        window.onload = () => {
            loadFromLocalStorage();
            showPage('main-page');
        };
    </script>
</body>
</html>
